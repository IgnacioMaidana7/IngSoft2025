# üîê Sistema de Permisos y Roles en IngSoft2025

## üìã Resumen Ejecutivo

Tu backend tiene un **sistema de roles jer√°rquico** con 3 niveles de acceso:

1. **üëî Administrador de Supermercado** - Acceso total
2. **üì¶ Reponedor** - Gesti√≥n de productos e inventario (solo su dep√≥sito)
3. **üí∞ Cajero** - Gesti√≥n de ventas (solo su dep√≥sito)

---

## üë• Roles y Permisos

### 1. üëî **Administrador de Supermercado**

**Tipo de Usuario:** `SupermercadoUser` (NO es `EmpleadoUser`)

**Permisos:**
- ‚úÖ **Productos:** Crear, editar, eliminar productos
- ‚úÖ **Stock:** Ver y gestionar stock en **TODOS los dep√≥sitos**
- ‚úÖ **Empleados:** Crear, editar, eliminar empleados
- ‚úÖ **Dep√≥sitos:** Gestionar m√∫ltiples dep√≥sitos
- ‚úÖ **Ventas:** Ver todas las ventas del supermercado
- ‚úÖ **Reportes:** Acceso completo a reportes y estad√≠sticas
- ‚úÖ **Notificaciones:** Recibe alertas de stock m√≠nimo

**C√≥digo:**
```python
# En permissions.py
class IsSupermercadoAdmin(BasePermission):
    def has_permission(self, request, view):
        # Verificar que NO sea un empleado
        return not isinstance(request.user, EmpleadoUser)
```

**Acceso a APIs:**
- Todas las rutas con `@permission_classes([IsReponedorOrAdmin])`
- Todas las rutas con `@permission_classes([IsCajeroOrAdmin])`

---

### 2. üì¶ **Reponedor**

**Tipo de Usuario:** `EmpleadoUser` con `puesto='REPONEDOR'`

**Permisos:**
- ‚úÖ **Productos:** Ver, crear y editar productos
- ‚úÖ **Stock:** Ver y gestionar stock **SOLO en su dep√≥sito asignado**
- ‚ùå **Stock otros dep√≥sitos:** NO puede ver ni modificar
- ‚úÖ **Categor√≠as:** Ver categor√≠as disponibles
- ‚ùå **Empleados:** NO puede gestionar empleados
- ‚ùå **Ventas:** NO puede acceder a ventas
- ‚úÖ **Notificaciones:** Recibe alertas de stock m√≠nimo de su dep√≥sito

**Restricci√≥n de Dep√≥sito:**
```python
# En views.py
if isinstance(user, EmpleadoUser):
    emp = Empleado.objects.filter(email=user.email, supermercado=user.supermercado).first()
    if emp:
        stocks_qs = stocks_qs.filter(deposito=emp.deposito)
```

**C√≥digo:**
```python
# En permissions.py
class IsReponedor(BasePermission):
    def has_permission(self, request, view):
        return (
            request.user.is_authenticated and
            isinstance(request.user, EmpleadoUser) and
            request.user.puesto == 'REPONEDOR' and
            request.user.is_active
        )
```

**Acceso a APIs:**
- Todas las rutas con `@permission_classes([IsReponedorOrAdmin])`
- Limitado a su dep√≥sito asignado

---

### 3. üí∞ **Cajero**

**Tipo de Usuario:** `EmpleadoUser` con `puesto='CAJERO'`

**Permisos:**
- ‚úÖ **Ventas:** Crear y gestionar ventas
- ‚úÖ **Productos (solo lectura):** Ver productos disponibles en su dep√≥sito
- ‚úÖ **Reconocimiento:** Usar API de reconocimiento de productos
- ‚ùå **Stock:** NO puede modificar stock
- ‚ùå **Productos:** NO puede crear/editar/eliminar productos
- ‚ùå **Empleados:** NO puede gestionar empleados

**C√≥digo:**
```python
# En permissions.py
class IsCajero(BasePermission):
    def has_permission(self, request, view):
        return (
            request.user.is_authenticated and
            isinstance(request.user, EmpleadoUser) and
            request.user.puesto == 'CAJERO' and
            request.user.is_active
        )
```

**Acceso a APIs:**
- Rutas con `@permission_classes([IsCajeroOrAdmin])`
- Ventas
- Reconocimiento de productos

---

## üìä Matriz de Permisos

| Funcionalidad                    | Admin üëî | Reponedor üì¶ | Cajero üí∞ |
|----------------------------------|----------|--------------|-----------|
| **Productos**                    |          |              |           |
| Ver productos                    | ‚úÖ       | ‚úÖ           | ‚úÖ (lectura) |
| Crear productos                  | ‚úÖ       | ‚úÖ           | ‚ùå        |
| Editar productos                 | ‚úÖ       | ‚úÖ           | ‚ùå        |
| Eliminar productos               | ‚úÖ       | ‚úÖ           | ‚ùå        |
| **Stock/Inventario**             |          |              |           |
| Ver stock (todos los dep√≥sitos)  | ‚úÖ       | ‚ùå           | ‚ùå        |
| Ver stock (su dep√≥sito)          | ‚úÖ       | ‚úÖ           | ‚úÖ        |
| Modificar stock (todos dep√≥sitos)| ‚úÖ       | ‚ùå           | ‚ùå        |
| Modificar stock (su dep√≥sito)    | ‚úÖ       | ‚úÖ           | ‚ùå        |
| **Ventas**                       |          |              |           |
| Ver todas las ventas             | ‚úÖ       | ‚ùå           | ‚ùå        |
| Crear ventas                     | ‚úÖ       | ‚ùå           | ‚úÖ        |
| Ver sus ventas                   | ‚úÖ       | ‚ùå           | ‚úÖ        |
| **Reconocimiento de Productos**  |          |              |           |
| Usar API reconocimiento          | ‚úÖ       | ‚ùå           | ‚úÖ        |
| **Empleados**                    |          |              |           |
| Crear empleados                  | ‚úÖ       | ‚ùå           | ‚ùå        |
| Editar empleados                 | ‚úÖ       | ‚ùå           | ‚ùå        |
| Eliminar empleados               | ‚úÖ       | ‚ùå           | ‚ùå        |
| **Dep√≥sitos**                    |          |              |           |
| Crear/editar dep√≥sitos           | ‚úÖ       | ‚ùå           | ‚ùå        |
| Ver dep√≥sitos                    | ‚úÖ       | ‚úÖ (solo el suyo) | ‚úÖ (solo el suyo) |
| **Notificaciones**               |          |              |           |
| Alertas de stock m√≠nimo          | ‚úÖ       | ‚úÖ (su dep√≥sito) | ‚ùå        |

---

## üîç Respuesta a tu Pregunta

> **"¬øSolo el administrador puede agregar productos en los dep√≥sitos?"**

### Respuesta: **NO, tanto Administradores como Reponedores pueden agregar productos**

### **Diferencias:**

#### üëî **Administrador:**
```python
# Puede agregar stock en CUALQUIER dep√≥sito
POST /api/productos/1/stock/
{
  "deposito": 1,      # ‚Üê Puede elegir cualquier dep√≥sito
  "cantidad": 50,
  "cantidad_minima": 10
}
```

#### üì¶ **Reponedor:**
```python
# Solo puede agregar stock en SU dep√≥sito asignado
POST /api/productos/1/stock/
{
  # El sistema FUERZA autom√°ticamente su dep√≥sito
  "cantidad": 50,
  "cantidad_minima": 10
}

# Si intenta especificar otro dep√≥sito, el sistema lo ignora:
if isinstance(request.user, EmpleadoUser):
    emp = Empleado.objects.filter(email=request.user.email).first()
    data['deposito'] = emp.deposito.id  # ‚Üê Forzado
```

---

## üèóÔ∏è Flujo de Creaci√≥n de Productos

### **Escenario 1: Admin crea producto**

```
1. Admin hace login ‚Üí SupermercadoUser
2. Crea producto:
   POST /api/productos/
   {
     "nombre": "Coca Cola 500ml",
     "categoria": 1,
     "precio": 150.00,
     "descripcion": "..."
   }
   ‚úÖ Producto creado (ID: 10)

3. Admin asigna stock en dep√≥sito 1:
   POST /api/productos/10/stock/
   {
     "deposito": 1,
     "cantidad": 100,
     "cantidad_minima": 20
   }
   ‚úÖ Stock creado en Dep√≥sito 1

4. Admin asigna stock en dep√≥sito 2:
   POST /api/productos/10/stock/
   {
     "deposito": 2,
     "cantidad": 50,
     "cantidad_minima": 10
   }
   ‚úÖ Stock creado en Dep√≥sito 2
```

### **Escenario 2: Reponedor crea producto**

```
1. Reponedor hace login ‚Üí EmpleadoUser (puesto='REPONEDOR', deposito_id=1)
2. Crea producto:
   POST /api/productos/
   {
     "nombre": "Sprite 500ml",
     "categoria": 1,
     "precio": 140.00,
     "descripcion": "..."
   }
   ‚úÖ Producto creado (ID: 11)

3. Reponedor asigna stock:
   POST /api/productos/11/stock/
   {
     "cantidad": 80,
     "cantidad_minima": 15
     # NO especifica dep√≥sito ‚Üí Sistema usa su dep√≥sito (1)
   }
   ‚úÖ Stock creado SOLO en SU Dep√≥sito 1

4. Reponedor intenta ver stock de dep√≥sito 2:
   GET /api/productos/11/stock/
   ‚ùå Solo ve stock de su dep√≥sito (1)

5. Reponedor intenta agregar stock en dep√≥sito 2:
   POST /api/productos/11/stock/
   {
     "deposito": 2,     # ‚Üê Intenta especificar dep√≥sito 2
     "cantidad": 50
   }
   ‚úÖ Creado, pero el sistema IGNORA el dep√≥sito 2
       y lo crea en su dep√≥sito (1) autom√°ticamente
```

---

## üõ°Ô∏è Seguridad del Sistema

### **Protecciones Implementadas:**

1. **Aislamiento por Dep√≥sito:**
```python
# Reponedores solo ven su dep√≥sito
if isinstance(user, EmpleadoUser):
    emp = Empleado.objects.filter(email=user.email).first()
    stocks_qs = stocks_qs.filter(deposito=emp.deposito)
```

2. **Forzado de Dep√≥sito:**
```python
# Reponedores no pueden elegir dep√≥sito
if isinstance(request.user, EmpleadoUser):
    data['deposito'] = emp.deposito.id  # Forzado por el sistema
```

3. **Verificaci√≥n de Permisos:**
```python
# En cada endpoint
@permission_classes([IsReponedorOrAdmin])
def gestionar_stock_producto(request, producto_id):
    # Validaciones de permisos
```

4. **Validaci√≥n de Propiedad:**
```python
# Verificar que el empleado pertenece al supermercado
if stock.deposito_id != emp.deposito_id:
    return Response({"detail": "No tiene acceso"}, status=403)
```

---

## üéØ Casos de Uso Reales

### **Caso 1: Stock Bajo - Reponedor Recibe Alerta**
```
1. Stock de "Coca Cola" baja de m√≠nimo en Dep√≥sito 1
2. Sistema env√≠a notificaci√≥n:
   - ‚úÖ Admin del supermercado
   - ‚úÖ Reponedores asignados al Dep√≥sito 1
   - ‚ùå Reponedores de otros dep√≥sitos
3. Reponedor de Dep. 1 ve notificaci√≥n y repone stock
```

### **Caso 2: Admin Consulta Stock Global**
```
GET /api/productos/1/stock-completo/
Respuesta (Admin):
{
  "producto": {"id": 1, "nombre": "Coca Cola"},
  "stocks": [
    {"deposito_id": 1, "cantidad": 5, "stock_bajo": true},
    {"deposito_id": 2, "cantidad": 50, "stock_bajo": false},
    {"deposito_id": 3, "cantidad": 0, "tiene_stock": false}
  ]
}
```

### **Caso 3: Reponedor Consulta Stock (Solo Su Dep√≥sito)**
```
GET /api/productos/1/stock-completo/
Respuesta (Reponedor Dep. 1):
{
  "producto": {"id": 1, "nombre": "Coca Cola"},
  "stocks": [
    {"deposito_id": 1, "cantidad": 5, "stock_bajo": true}
    # No ve los otros dep√≥sitos
  ]
}
```

### **Caso 4: Cajero Usa Reconocimiento**
```
1. Cajero toma foto de productos
2. API reconoce: Fritolim (ID Django: 1)
3. Backend consulta stock del dep√≥sito del cajero:
   {
     "ingsoft_product_id": 1,
     "nombre_db": "Fritolim",
     "precio_db": "680.00",
     "stock_disponible": 50  ‚Üê Stock del dep√≥sito del cajero
   }
4. Cajero agrega a la venta
```

---

## üìù Configuraci√≥n Inicial Recomendada

### **1. Crear Dep√≥sitos**
```python
# Admin crea 3 dep√≥sitos
POST /api/depositos/
{"nombre": "Dep√≥sito Central", "direccion": "..."}
POST /api/depositos/
{"nombre": "Dep√≥sito Norte", "direccion": "..."}
POST /api/depositos/
{"nombre": "Dep√≥sito Sur", "direccion": "..."}
```

### **2. Crear Empleados**
```python
# Admin crea reponedores y cajeros
POST /api/empleados/
{
  "nombre": "Juan P√©rez",
  "email": "juan@super.com",
  "puesto": "REPONEDOR",
  "deposito_id": 1  # ‚Üê Asignado al Dep√≥sito Central
}
```

### **3. Crear Productos (Admin o Reponedores)**
```python
# Cualquiera puede crear productos
POST /api/productos/
{"nombre": "Coca Cola", "categoria": 1, "precio": 150}
```

### **4. Asignar Stock**
```python
# Admin: puede asignar en cualquier dep√≥sito
# Reponedor: solo en su dep√≥sito asignado
POST /api/productos/1/stock/
{"cantidad": 100, "cantidad_minima": 20}
```

---

## ‚ö†Ô∏è Limitaciones y Consideraciones

1. **Un Reponedor = Un Dep√≥sito**
   - Cada reponedor est√° asignado a un solo dep√≥sito
   - No puede trabajar en m√∫ltiples dep√≥sitos simult√°neamente

2. **Productos sin Dep√≥sito**
   - Un producto puede existir sin stock en ning√∫n dep√≥sito
   - No se puede eliminar un producto con stock > 0

3. **Cajeros y Stock**
   - Los cajeros **ven** el stock pero **NO pueden modificarlo**
   - Solo pueden crear ventas

4. **Notificaciones Autom√°ticas**
   - Se env√≠an al guardar stock (signal `post_save`)
   - Solo a reponedores del dep√≥sito espec√≠fico

---

## üöÄ Resumen Final

### **¬øQui√©n puede agregar productos en dep√≥sitos?**

| Rol         | Crear Producto | Agregar Stock | Dep√≥sitos Permitidos |
|-------------|----------------|---------------|----------------------|
| Admin üëî    | ‚úÖ             | ‚úÖ            | Todos                |
| Reponedor üì¶| ‚úÖ             | ‚úÖ            | Solo el suyo         |
| Cajero üí∞   | ‚ùå             | ‚ùå            | Ninguno (solo lee)   |

### **Flujo Recomendado:**
1. **Admin** crea la estructura (dep√≥sitos, categor√≠as, empleados)
2. **Reponedores** crean productos y gestionan stock de sus dep√≥sitos
3. **Cajeros** usan productos para ventas
4. **Admin** supervisa todo desde una vista global

**Tu sistema est√° bien dise√±ado con separaci√≥n de responsabilidades y seguridad por dep√≥sito.** ‚úÖ
